# Health Service

As described in the [conceptual description](/docs/reference-implementation/Health-Application-HealthService.md) of the health service, this API reports its own "liveness" along with the availability of the whole regional stamp. In order to do that, it performs the following checks:

- Does a health state file exist on Blob Storage? (and thereby: is the Blob storage itself available?)
- Is is possible to send messages to Event Hub?
- Is it possible to query Cosmos DB?

## Configuration

Refer to [GameService configuration](../AlwaysOn.GameService/README.md#Configuration) for details of the implementation.

Apart from the configuration settings which are common between components, such as Cosmos DB connection settings, the following settings are used exclusively by the HealthService:

- `HealthServiceCacheDurationSeconds`: Controls the expiration time of memory cache, in seconds.
- `HealthServiceStorageConnectionString`: Connection string for the Storage Account where the status file should be present.
- `HealthServiceBlobContainerName`: Storage Container where the status file should be present.
- `HealthServiceBlobName`: Name of the status file - health check will look for this.
- `HealthServiceOverallTimeoutSeconds`: Timeout for the whole check - defaults to 3 seconds. If the check doesn't finish in this interval, the service reports unhealthy.

## Implementation

All checks are done asynchronously and **in parallel**. If either of them fails, **the whole stamp will be considered unavailable**.

Check results are **cached in memory**, using the standard, non-distributed ASP.NET Core `MemoryCache`. Cache expiration is controlled by `SysConfig.HealthServiceCacheDurationSeconds` and is set to 10 seconds by default.

> This reduces the additional load generated by health checks as not every request will result in downstream call to the dependent services.

### Blob check

The blob check currently serves two purposes:

1. Test if it's possible to reach Blob Storage. This storage account is also used by other components in the stamp and hence considered a critical resource.
1. Manually "turn off" a region by manipulating (i.e. deleting) the state file.

We decided that this check should **only look for the presence of a state file** in the specified Blob Container, but not process its content in any way. There is also the possibility to set up a more sophisticated system which would read the content of the file and return different status based on that (such as *"HEALTHY"*, *"UNHEALTHY"*, *"MAINTENANCE"* etc.).

**Remove** the state file to disable a stamp.

Make sure the file is present after deploying the application - otherwise the health service will always respond with *UNHEALTHY* and Front Door will not recognize the backend as available. This file does get created by Terraform so it should be present after the infrastructure deployment.

### Event Hub check

Event Hub health reporting is handled by the `EventHubProducerService`. This service reports healthy if it's able to send a new message to Event Hub. For filtering, this message has an identifying property added to it:

```
HEALTHCHECK=TRUE
```

This message is ignored on the receiving end (`AlwaysOn.ResultWorker.EventHubProcessorService.ProcessEventHanderAsync()`), which checks for the HEALTHCHECK property.

### Cosmos DB check

Cosmos DB health reporting is handled by the `CosmosDbService`, which reports healthy if it is:
- Able to connect to Cosmos DB database and perform a simple query.
- Able to write a test document to the database (the test document has a very short Time-to-Live set, so Cosmos DB automatically removes it).

The HealthService is doing two separate probes since Cosmos DB could be in a state in which reads still work, but writing documents does not.

For the Read-only query, the following query is being used, which doesn't fetch any data and doesn't have large impact on overall load:

```sql
SELECT GetCurrentDateTime ()
```

The write query creates a dummy GameResult with minimum content:

```csharp
var testGameResult = new GameResult()
{
    Id = Guid.NewGuid(),
    GameDate = DateTime.UtcNow,
    IsHealthCheck = true,
    TimeToLive = 10 // will be auto-deleted after 10sec
};

await AddNewGameResultAsync(testGameResult);
```


---

[Back to documentation root](/docs/README.md)
